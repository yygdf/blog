<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.iksling.blog.mapper.ArticleMapper">

    <resultMap id="BaseResultMap" type="com.iksling.blog.entity.Article">
            <id property="id" column="id" jdbcType="INTEGER"/>
            <result property="userId" column="user_id" jdbcType="INTEGER"/>
            <result property="categoryId" column="category_id" jdbcType="INTEGER"/>
            <result property="articleTitle" column="article_title" jdbcType="VARCHAR"/>
            <result property="articleCover" column="article_cover" jdbcType="VARCHAR"/>
            <result property="articleContent" column="article_content" jdbcType="VARCHAR"/>
            <result property="topFlag" column="top_flag" jdbcType="BOOLEAN"/>
            <result property="draftFlag" column="draft_flag" jdbcType="BOOLEAN"/>
            <result property="publicFlag" column="public_flag" jdbcType="BOOLEAN"/>
            <result property="hiddenFlag" column="hidden_flag" jdbcType="BOOLEAN"/>
            <result property="recycleFlag" column="recycle_flag" jdbcType="BOOLEAN"/>
            <result property="deletedFlag" column="deleted_flag" jdbcType="BOOLEAN"/>
            <result property="commentableFlag" column="commentable_flag" jdbcType="BOOLEAN"/>
            <result property="ipSource" column="ip_source" jdbcType="VARCHAR"/>
            <result property="ipAddress" column="ip_address" jdbcType="VARCHAR"/>
            <result property="createUser" column="create_user" jdbcType="INTEGER"/>
            <result property="createTime" column="create_time" jdbcType="TIMESTAMP"/>
            <result property="updateUser" column="update_user" jdbcType="INTEGER"/>
            <result property="updateTime" column="update_time" jdbcType="TIMESTAMP"/>
            <result property="publishUser" column="publish_user" jdbcType="INTEGER"/>
            <result property="publishTime" column="publish_time" jdbcType="TIMESTAMP"/>
    </resultMap>

    <resultMap id="articlesBackResultMap" type="com.iksling.blog.dto.ArticlesBackDTO">
        <id column="id" property="id"/>
        <result column="user_id" property="userId"/>
        <result column="username" property="username"/>
        <result column="article_title" property="articleTitle"/>
        <result column="top_flag" property="topFlag"/>
        <result column="public_flag" property="publicFlag"/>
        <result column="hidden_flag" property="hiddenFlag"/>
        <result column="commentable_flag" property="commentableFlag"/>
        <result column="publish_time" property="publishTime"/>
        <result column="update_time" property="updateTime"/>
        <result column="category_name" property="categoryName"/>
        <collection property="tagDTOList" ofType="com.iksling.blog.dto.TagDTO">
            <id column="tag_id" property="id"/>
            <result column="user_id" property="userId"/>
            <result column="tag_name" property="tagName"/>
        </collection>
    </resultMap>

    <sql id="Base_Column_List">
        id,user_id,category_id,
        article_title,article_cover,article_content,
        top_flag,draft_flag,public_flag,
        hidden_flag,recycle_flag,deleted_flag,
        commentable_flag,ip_source,ip_address,
        create_user,create_time,update_user,
        update_time,publish_user,publish_time
    </sql>

    <select id="listArticlesBackDTO" resultMap="articlesBackResultMap">
        SELECT
            a.id,a.user_id,ua.username,
            a.article_title,a.top_flag,a.public_flag,
            a.hidden_flag,a.commentable_flag,a.publish_time,
            a.update_time,c.category_name,t.id tag_id,
            t.tag_name
        FROM
            (
            SELECT
                id,user_id,category_id,
                article_title,top_flag,public_flag,
                hidden_flag,commentable_flag,publish_time,
                update_time
            FROM
                tb_article
            <where>
                recycle_flag = #{condition.recycleFlag}
                AND deleted_flag = #{condition.deletedFlag}
                <choose>
                    <when test="roleWeight > 300">
                        AND user_id = #{userId}
                    </when>
                    <otherwise>
                        <if test="condition.userId != null">
                            AND user_id = #{condition.userId}
                        </if>
                    </otherwise>
                </choose>
                <if test="condition.draftFlag != null">
                    AND draft_flag = #{condition.draftFlag}
                </if>
                <if test="condition.categoryId != null">
                    AND category_id = #{condition.categoryId}
                </if>
                <if test="condition.keywords != null">
                    AND article_title like concat('%', #{condition.keywords}, '%')
                </if>
                <if test="condition.tagIdList != null and condition.tagIdList.size() != 0">
                    AND id in
                        (
                        SELECT
                            ata.article_id
                        FROM
                            tb_article_tag ata
                        WHERE
                            ata.tag_id in
                            <foreach collection="condition.tagIdList" item="tagId" index="index" open="(" separator="," close=")">
                                #{tagId}
                            </foreach>
                        )
                </if>
            </where>
            ORDER BY
                top_flag DESC,
                id DESC
            LIMIT
                #{condition.current}, #{condition.size}
            ) a
            LEFT JOIN tb_category c ON a.category_id = c.id
            LEFT JOIN tb_article_tag ata ON a.id = ata.article_id
            LEFT JOIN tb_tag t ON ata.tag_id = t.id
            LEFT JOIN tb_user_auth ua ON a.user_id = ua.user_id
        ORDER BY
            a.top_flag DESC,
            a.id DESC,
            t.id ASC
    </select>

    <update id="updateArticlesStatus">
        UPDATE
            tb_article
        SET
            recycle_flag = #{updateBatch.recycleFlag},
            deleted_flag = #{updateBatch.deletedFlag}
            <if test="updateBatch.recycleFlag">
                , draft_flag = 1
            </if>
        WHERE
            id in
            <foreach collection="updateBatch.idList" item="id" index="index" open="(" separator="," close=")">
                #{id}
            </foreach>
            <if test="roleWeight > 300">
                AND user_id = #{userId}
            </if>
            <if test="roleWeight > 100">
                AND deleted_flag = 0
            </if>
    </update>

    <select id="selectCategoryArticleCount" resultType="com.iksling.blog.dto.CategoryArticleDTO">
        SELECT
            category_id categoryId,
            count(*) articleCount
        FROM
            tb_article
        WHERE
            category_id != -1
            AND deleted_flag = 0
            AND category_id in
            <foreach collection="categoryIdList" item="categoryId" index="index" open="(" separator="," close=")">
                #{categoryId}
            </foreach>
        GROUP BY
            category_id;
    </select>
</mapper>
